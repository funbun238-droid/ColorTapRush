<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>‚öîÔ∏è Knight's Ascent</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=MedievalSharp&family=Cinzel:wght@700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            font-family: 'MedievalSharp', serif; 
            background: #000; 
            color: #FFD700; 
            overflow: hidden; 
            touch-action: none; 
            position: fixed; 
            width: 100vw; 
            height: 100vh; 
        }
        @media (orientation: portrait) {
            body::before { 
                content: "‚ü≤ ROTATE DEVICE ‚ü≤"; 
                position: fixed; 
                top: 0; 
                left: 0; 
                width: 100%; 
                height: 100%; 
                background: #000; 
                display: flex; 
                align-items: center; 
                justify-content: center; 
                font-size: 2em; 
                z-index: 99999; 
                color: #FFD700; 
            }
        }
        #gameCanvas { 
            display: block; 
            width: 100vw; 
            height: 100vh; 
            background: #000; 
            image-rendering: pixelated; 
        }
        .screen { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: linear-gradient(135deg, #2a0a0a 0%, #0a0a0a 100%); 
            justify-content: center; 
            align-items: center; 
            flex-direction: column; 
            z-index: 100; 
        }
        .screen.active { display: flex; }
        .title { 
            font-family: 'Cinzel', serif; 
            font-size: 3em; 
            margin-bottom: 40px; 
            text-shadow: 4px 4px 0 #8B0000; 
            color: #FFD700; 
            font-weight: 700; 
        }
        .menu-btn { 
            background: linear-gradient(135deg, #8B0000 0%, #DC143C 50%, #8B0000 100%); 
            border: 4px solid #FFD700; 
            color: #FFD700; 
            padding: 20px 50px; 
            font-size: 1.3em; 
            margin: 12px; 
            cursor: pointer; 
            font-weight: bold; 
            text-transform: uppercase; 
            font-family: 'MedievalSharp', serif; 
        }
        .menu-btn:active { transform: scale(0.95); }
        .back-btn { 
            background: #555; 
            border: 3px solid #999; 
            color: #CCC; 
            padding: 15px 35px; 
            font-size: 1em; 
            margin-top: 30px; 
            cursor: pointer; 
            font-weight: bold; 
            text-transform: uppercase; 
            font-family: 'MedievalSharp', serif; 
        }
        .options-container { display: flex; gap: 30px; flex-wrap: wrap; justify-content: center; }
        .option-box { 
            background: rgba(139, 0, 0, 0.4); 
            border: 3px solid #FFD700; 
            padding: 25px; 
            min-width: 250px; 
        }
        .option-box h3 { 
            font-size: 1.3em; 
            margin-bottom: 15px; 
            color: #FFD700; 
        }
        .option-btn { 
            background: #444; 
            border: 2px solid #888; 
            color: #CCC; 
            padding: 12px 25px; 
            margin: 8px; 
            cursor: pointer; 
            font-family: 'MedievalSharp', serif; 
        }
        .option-btn.selected { 
            background: #FFD700; 
            color: #000; 
            transform: scale(1.05); 
        }
        #controls { 
            position: fixed; 
            bottom: 15px; 
            width: 100%; 
            display: none; 
            justify-content: space-between; 
            padding: 0 15px; 
            z-index: 50; 
        }
        #controls.active { display: flex; }
        .control-group { display: flex; gap: 8px; }
        .control-btn { 
            width: 75px; 
            height: 75px; 
            background: rgba(139, 0, 0, 0.95); 
            border: 3px solid #FFD700; 
            border-radius: 10px; 
            color: #FFD700; 
            font-size: 0.75em; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            user-select: none; 
            touch-action: none; 
            font-weight: bold; 
            font-family: 'MedievalSharp', serif; 
        }
        .control-btn:active { 
            background: rgba(220, 20, 60, 0.95); 
            transform: scale(0.9); 
        }
        #hud { position: fixed; top: 15px; width: 100%; display: none; z-index: 50; }
        #hud.active { display: block; }
        .health-container { 
            display: flex; 
            justify-content: space-between; 
            padding: 0 15px; 
            margin-bottom: 8px; 
        }
        .health-bar { 
            width: 38%; 
            height: 30px; 
            background: rgba(0, 0, 0, 0.9); 
            border: 3px solid #FFD700; 
            position: relative; 
        }
        .health-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #8B0000 0%, #DC143C 50%, #FF4500 100%); 
            transition: width 0.3s ease; 
        }
        .health-text { 
            position: absolute; 
            width: 100%; 
            text-align: center; 
            line-height: 30px; 
            font-size: 0.85em; 
            color: #FFD700; 
            font-weight: bold; 
            text-shadow: 2px 2px 0 #000; 
        }
        #levelInfo { 
            text-align: center; 
            font-size: 1.1em; 
            color: #FFD700; 
            font-weight: bold; 
            text-shadow: 3px 3px 0 #000; 
            font-family: 'Cinzel', serif; 
        }
    </style>
</head>
<body>
    <div id="mainMenu" class="screen active">
        <h1 class="title">‚öîÔ∏è KNIGHT'S ASCENT ‚öîÔ∏è</h1>
        <button class="menu-btn" onclick="game.startGame()">‚öîÔ∏è START CAMPAIGN</button>
        <button class="menu-btn" onclick="game.showOptions()">‚öôÔ∏è OPTIONS</button>
    </div>

    <div id="optionsScreen" class="screen">
        <h1 class="title">OPTIONS</h1>
        <div class="options-container">
            <div class="option-box">
                <h3>GORE</h3>
                <button class="option-btn selected" data-opt="gore-on" onclick="game.setGore(true)">ON</button>
                <button class="option-btn" data-opt="gore-off" onclick="game.setGore(false)">OFF</button>
            </div>
            <div class="option-box">
                <h3>DIFFICULTY</h3>
                <button class="option-btn selected" data-opt="diff-normal" onclick="game.setDifficulty('normal')">NORMAL</button>
                <button class="option-btn" data-opt="diff-hard" onclick="game.setDifficulty('hard')">HARD</button>
            </div>
        </div>
        <button class="back-btn" onclick="game.showMenu()">‚¨Ö BACK</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="hud">
        <div class="health-container">
            <div class="health-bar">
                <div class="health-fill" id="playerHealth" style="width: 100%"></div>
                <div class="health-text">YOU</div>
            </div>
            <div class="health-bar">
                <div class="health-fill" id="enemyHealth" style="width: 100%"></div>
                <div class="health-text">ENEMY</div>
            </div>
        </div>
        <div id="levelInfo">LEVEL 1: FIELD BATTLE</div>
    </div>

    <div id="controls">
        <div class="control-group">
            <div class="control-btn" id="leftBtn">‚Üê<br>LEFT</div>
            <div class="control-btn" id="rightBtn">‚Üí<br>RIGHT</div>
        </div>
        <div class="control-group">
            <div class="control-btn" id="blockBtn">üõ°<br>BLOCK</div>
            <div class="control-btn" id="dodgeBtn">‚Üî<br>DODGE</div>
            <div class="control-btn" id="attackBtn">‚öî<br>ATTACK</div>
        </div>
    </div>

    <script>
        const game = {
            canvas: null, ctx: null, gore: true, difficulty: 'normal', currentLevel: 0,
            player: { x: 200, y: 0, vx: 0, health: 100, maxHealth: 100, isBlocking: false, isAttacking: false, isDodging: false, animState: 'idle', animFrame: 0, animTimer: 0 },
            enemy: { x: 600, y: 0, vx: 0, health: 100, maxHealth: 100, isBlocking: false, isAttacking: false, animState: 'idle', animFrame: 0, animTimer: 0, aiTimer: 0 },
            blood: [], gameRunning: false, sprites: {}, groundY: 0,

            levels: [
                { name: 'FIELD BATTLE', bgUrl: 'https://pub-b70cb36a6853407fa468c5d6dec16633.r2.dev/208307/gemini/generate_image/response/a479852528778d342fc3039cfcbfe12f', difficulty: 1 },
                { name: 'VILLAGE SQUARE', bgUrl: 'https://pub-b70cb36a6853407fa468c5d6dec16633.r2.dev/208307/gemini/generate_image/response/a2662d71b32b1a6ad73d78db07098e8b', difficulty: 1.4 },
                { name: 'CASTLE COURTYARD', bgUrl: 'https://pub-b70cb36a6853407fa468c5d6dec16633.r2.dev/208307/gemini/generate_image/response/11091d5c1a0be80919b4d87957931056', difficulty: 1.7 },
                { name: 'THRONE ROOM', bgUrl: 'https://pub-b70cb36a6853407fa468c5d6dec16633.r2.dev/208307/gemini/generate_image/response/224003a466ee5c1e77e35c25c4618664', difficulty: 2.2 }
            ],

            init() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.setupControls();
                this.loadAssets();
            },

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.groundY = this.canvas.height - 100;
                this.player.y = this.groundY - 100;
                this.enemy.y = this.groundY - 100;
            },

            loadAssets() {
                const assets = [
                    { key: 'knight', src: 'https://pub-b70cb36a6853407fa468c5d6dec16633.r2.dev/208307/gemini/generate_image/response/3ad9f8b0639b1aa35774a5099816649a' },
                    { key: 'sword', src: 'https://pub-b70cb36a6853407fa468c5d6dec16633.r2.dev/208307/gemini/generate_image/response/cc25667dd8c0c8be70182b12dd1d7f1c' }
                ];
                this.levels.forEach((l, i) => assets.push({ key: `bg${i}`, src: l.bgUrl }));

                assets.forEach(item => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.onload = () => { this.sprites[item.key] = img; console.log(`Loaded ${item.key}`); };
                    img.onerror = () => console.log(`Failed ${item.key}`);
                    img.src = item.src;
                });
            },

            showMenu() {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('mainMenu').classList.add('active');
                document.getElementById('hud').classList.remove('active');
                document.getElementById('controls').classList.remove('active');
                this.gameRunning = false;
            },

            showOptions() {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('optionsScreen').classList.add('active');
            },

            setGore(enabled) {
                this.gore = enabled;
                document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                document.querySelectorAll(`[data-opt="gore-${enabled ? 'on' : 'off'}"]`).forEach(b => b.classList.add('selected'));
            },

            setDifficulty(diff) {
                this.difficulty = diff;
                document.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                document.querySelectorAll(`[data-opt="diff-${diff}"]`).forEach(b => b.classList.add('selected'));
            },

            startGame() {
                this.currentLevel = 0;
                this.loadLevel(0);
            },

            loadLevel(level) {
                this.currentLevel = level;
                this.player.health = this.player.maxHealth;
                this.enemy.health = this.enemy.maxHealth;
                this.player.x = 200;
                this.player.y = this.groundY - 100;
                this.enemy.x = this.canvas.width - 200;
                this.enemy.y = this.groundY - 100;
                this.blood = [];

                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('hud').classList.add('active');
                document.getElementById('controls').classList.add('active');
                document.getElementById('levelInfo').textContent = `LEVEL ${level + 1}: ${this.levels[level].name}`;

                this.updateHealthBars();
                this.gameRunning = true;
                this.gameLoop();
            },

            setupControls() {
                const actions = { 'leftBtn': 'left', 'rightBtn': 'right', 'attackBtn': 'attack', 'blockBtn': 'block', 'dodgeBtn': 'dodge' };
                Object.keys(actions).forEach(btnId => {
                    const btn = document.getElementById(btnId);
                    const action = actions[btnId];
                    ['touchstart', 'mousedown'].forEach(evt => {
                        btn.addEventListener(evt, (e) => { e.preventDefault(); this.handleAction(action, true); });
                    });
                    ['touchend', 'mouseup'].forEach(evt => {
                        btn.addEventListener(evt, (e) => { e.preventDefault(); this.handleAction(action, false); });
                    });
                });
            },

            handleAction(action, pressed) {
                if (!this.gameRunning) return;
                const speed = 6;
                switch(action) {
                    case 'left':
                        this.player.vx = pressed ? -speed : 0;
                        this.player.animState = pressed ? 'walk' : 'idle';
                        break;
                    case 'right':
                        this.player.vx = pressed ? speed : 0;
                        this.player.animState = pressed ? 'walk' : 'idle';
                        break;
                    case 'attack':
                        if (pressed && !this.player.isAttacking) {
                            this.player.isAttacking = true;
                            this.player.animState = 'attack';
                            this.player.animFrame = 0;
                            setTimeout(() => this.playerAttack(), 200);
                            setTimeout(() => { this.player.isAttacking = false; this.player.animState = 'idle'; }, 500);
                        }
                        break;
                    case 'block':
                        this.player.isBlocking = pressed;
                        this.player.animState = pressed ? 'block' : 'idle';
                        break;
                    case 'dodge':
                        if (pressed && !this.player.isDodging) {
                            this.player.isDodging = true;
                            this.player.vx = (this.player.x < this.canvas.width / 2) ? 15 : -15;
                            setTimeout(() => { this.player.isDodging = false; this.player.vx = 0; }, 200);
                        }
                        break;
                }
            },

            playerAttack() {
                const dist = Math.abs(this.player.x - this.enemy.x);
                if (dist < 130 && !this.enemy.isBlocking) {
                    this.enemy.health -= 15;
                    this.addBlood(this.enemy.x, this.enemy.y + 30);
                    this.updateHealthBars();
                }
            },

            enemyAI() {
                this.enemy.aiTimer++;
                if (this.enemy.aiTimer < 50) return;
                this.enemy.aiTimer = 0;
                const dist = Math.abs(this.player.x - this.enemy.x);
                if (dist > 140) {
                    this.enemy.vx = this.player.x > this.enemy.x ? 3 : -3;
                    this.enemy.animState = 'walk';
                } else {
                    this.enemy.vx = 0;
                    const action = Math.random();
                    if (action < 0.3 && !this.enemy.isAttacking) {
                        this.enemy.isAttacking = true;
                        this.enemy.animState = 'attack';
                        this.enemy.animFrame = 0;
                        setTimeout(() => {
                            const d = Math.abs(this.player.x - this.enemy.x);
                            if (d < 130 && !this.player.isBlocking) {
                                this.player.health -= 12;
                                this.addBlood(this.player.x, this.player.y + 30);
                                this.updateHealthBars();
                            }
                            this.enemy.isAttacking = false;
                            this.enemy.animState = 'idle';
                        }, 500);
                    }
                }
            },

            addBlood(x, y) {
                if (!this.gore) return;
                for (let i = 0; i < 10; i++) {
                    this.blood.push({ x, y, vx: (Math.random() - 0.5) * 8, vy: -Math.random() * 6 - 3, life: 100, size: Math.random() * 5 + 2 });
                }
            },

            updateHealthBars() {
                document.getElementById('playerHealth').style.width = Math.max(0, this.player.health / this.player.maxHealth * 100) + '%';
                document.getElementById('enemyHealth').style.width = Math.max(0, this.enemy.health / this.enemy.maxHealth * 100) + '%';
                if (this.player.health <= 0) this.gameOver(false);
                else if (this.enemy.health <= 0) this.levelComplete();
            },

            gameOver(won) {
                this.gameRunning = false;
                setTimeout(() => {
                    alert(won ? '‚öîÔ∏è VICTORY!' : 'üíÄ DEFEAT!');
                    this.showMenu();
                }, 700);
            },

            levelComplete() {
                this.gameRunning = false;
                setTimeout(() => {
                    if (this.currentLevel < this.levels.length - 1) {
                        alert(`Level ${this.currentLevel + 1} Complete!`);
                        this.loadLevel(this.currentLevel + 1);
                    } else {
                        this.gameOver(true);
                    }
                }, 700);
            },

            drawKnight(entity, isEnemy) {
                const ctx = this.ctx;
                const x = entity.x;
                const y = entity.y;

                // Draw sprite if available
                if (this.sprites.knight) {
                    const frameWidth = this.sprites.knight.width / 10; // 10 frames
                    const frameMap = { idle: 0, walk: 1, attack: 3, block: 7, hit: 8, death: 9 };
                    const frame = frameMap[entity.animState] || 0;

                    ctx.save();
                    if (isEnemy) {
                        ctx.translate(x, y);
                        ctx.scale(-1, 1);
                        ctx.drawImage(this.sprites.knight, frame * frameWidth, 0, frameWidth, this.sprites.knight.height, -60, -10, 120, 120);
                    } else {
                        ctx.drawImage(this.sprites.knight, frame * frameWidth, 0, frameWidth, this.sprites.knight.height, x - 60, y - 10, 120, 120);
                    }
                    ctx.restore();
                } else {
                    // Fallback rendering
                    ctx.fillStyle = '#c0c0c0';
                    ctx.fillRect(x - 20, y + 20, 40, 80);
                }

                // Draw sword
                this.drawSword(x, y, isEnemy, entity);
            },

            drawSword(x, y, isEnemy, entity) {
                const ctx = this.ctx;
                ctx.fillStyle = '#d0d0d0';
                const dir = isEnemy ? -1 : 1;

                if (entity.isAttacking) {
                    ctx.save();
                    ctx.translate(x + (dir * 30), y + 50);
                    ctx.rotate((dir * -60) * Math.PI / 180);
                    ctx.fillRect(0, 0, 8, 60);
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(-2, 60, 12, 12);
                    ctx.restore();
                } else {
                    ctx.fillRect(x + (dir * 25), y + 50, 8, 60);
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(x + (dir * 23), y + 110, 12, 12);
                }
            },

            gameLoop() {
                if (!this.gameRunning) return;
                const ctx = this.ctx;

                // Clear
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // Background - FULL SCREEN
                const bgKey = `bg${this.currentLevel}`;
                if (this.sprites[bgKey]) {
                    ctx.drawImage(this.sprites[bgKey], 0, 0, this.canvas.width, this.canvas.height);
                } else {
                    const grad = ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                    grad.addColorStop(0, '#4a6fa5');
                    grad.addColorStop(0.7, '#2a5f2a');
                    grad.addColorStop(1, '#1a4a1a');
                    ctx.fillStyle = grad;
                    ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                }

                // Ground
                ctx.fillStyle = '#2a4a2a';
                ctx.fillRect(0, this.groundY, this.canvas.width, this.canvas.height - this.groundY);

                // Blood
                this.blood = this.blood.filter(drop => {
                    drop.x += drop.vx;
                    drop.y += drop.vy;
                    drop.vy += 0.5;
                    drop.life--;
                    if (drop.y >= this.groundY) {
                        drop.y = this.groundY;
                        drop.vy = 0;
                        drop.vx *= 0.7;
                    }
                    if (drop.life > 0) {
                        ctx.fillStyle = `rgba(139, 0, 0, ${drop.life / 100})`;
                        ctx.beginPath();
                        ctx.arc(drop.x, drop.y, drop.size, 0, Math.PI * 2);
                        ctx.fill();
                        return true;
                    }
                    return false;
                });

                // Update positions
                this.player.x += this.player.vx;
                this.enemy.x += this.enemy.vx;
                this.player.x = Math.max(80, Math.min(this.canvas.width / 2, this.player.x));
                this.enemy.x = Math.max(this.canvas.width / 2, Math.min(this.canvas.width - 80, this.enemy.x));

                // Draw knights
                this.drawKnight(this.player, false);
                this.drawKnight(this.enemy, true);

                // AI
                this.enemyAI();

                requestAnimationFrame(() => this.gameLoop());
            }
        };

        window.addEventListener('load', () => game.init());
    </script>
</body>
</html>