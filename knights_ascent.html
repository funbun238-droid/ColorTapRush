<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>‚öîÔ∏è KNIGHT'S ASCENT ‚öîÔ∏è</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=MedievalSharp&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'MedievalSharp', 'Courier New', serif;
            background: #000;
            color: #FFD700;
            overflow: hidden;
            touch-action: none;
            position: fixed;
            width: 100vw;
            height: 100vh;
        }

        /* Landscape mode enforcer */
        @media (orientation: portrait) {
            body::before {
                content: "‚ü≤ ROTATE YOUR DEVICE ‚ü≤";
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: #000;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 2.5em;
                z-index: 99999;
                color: #FFD700;
                text-align: center;
                padding: 20px;
            }
        }

        #gameCanvas {
            display: block;
            width: 100vw;
            height: 100vh;
            background: #000;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        .screen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #1a0a00 0%, #3d2409 50%, #1a0a00 100%);
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            padding: 20px;
        }

        .screen.active {
            display: flex;
        }

        .screen::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(0,0,0,0.1) 2px,
                    rgba(0,0,0,0.1) 4px
                );
            pointer-events: none;
            z-index: -1;
        }

        .title {
            font-size: 3.5em;
            margin-bottom: 50px;
            text-shadow: 
                3px 3px 0 #8B0000,
                6px 6px 10px rgba(139,0,0,0.5);
            color: #FFD700;
            font-weight: bold;
            letter-spacing: 5px;
            text-align: center;
            animation: titleGlow 2s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% { 
                text-shadow: 
                    3px 3px 0 #8B0000,
                    6px 6px 10px rgba(139,0,0,0.5);
            }
            50% { 
                text-shadow: 
                    3px 3px 0 #DC143C,
                    6px 6px 20px rgba(220,20,60,0.8),
                    0 0 30px rgba(255,215,0,0.3);
            }
        }

        .menu-btn {
            background: linear-gradient(180deg, #8B0000 0%, #5a0000 100%);
            border: 4px solid #FFD700;
            border-radius: 8px;
            color: #FFD700;
            padding: 20px 50px;
            font-size: 1.4em;
            margin: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 3px;
            box-shadow: 
                0 6px 0 #3a0000,
                0 10px 20px rgba(0,0,0,0.5),
                inset 0 1px 0 rgba(255,255,255,0.2);
            position: relative;
            font-family: 'MedievalSharp', serif;
        }

        .menu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 8px 0 #3a0000,
                0 12px 25px rgba(0,0,0,0.6),
                inset 0 1px 0 rgba(255,255,255,0.3);
        }

        .menu-btn:active {
            transform: translateY(4px);
            box-shadow: 
                0 2px 0 #3a0000,
                0 4px 10px rgba(0,0,0,0.4);
        }

        .back-btn {
            background: linear-gradient(180deg, #4a4a4a 0%, #2a2a2a 100%);
            border: 3px solid #888;
            border-radius: 6px;
            color: #FFD700;
            padding: 15px 35px;
            font-size: 1.1em;
            margin-top: 30px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 4px 0 #1a1a1a, 0 6px 15px rgba(0,0,0,0.4);
            font-family: 'MedievalSharp', serif;
        }

        .back-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #1a1a1a;
        }

        .options-container {
            display: flex;
            flex-direction: column;
            gap: 25px;
            background: rgba(0,0,0,0.4);
            padding: 30px;
            border: 3px solid #FFD700;
            border-radius: 10px;
            max-width: 600px;
        }

        .option-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .option-label {
            font-size: 1.2em;
            color: #FFD700;
            font-weight: bold;
            min-width: 150px;
        }

        .option-btns {
            display: flex;
            gap: 10px;
        }

        .option-btn {
            background: rgba(139, 0, 0, 0.6);
            border: 2px solid #FFD700;
            color: #FFD700;
            padding: 10px 20px;
            font-size: 0.9em;
            cursor: pointer;
            font-weight: bold;
            border-radius: 4px;
            font-family: 'MedievalSharp', serif;
            transition: all 0.2s;
        }

        .option-btn.selected {
            background: #FFD700;
            color: #8B0000;
            box-shadow: 0 0 15px rgba(255,215,0,0.6);
        }

        .option-btn:active {
            transform: scale(0.95);
        }

        #controls {
            position: fixed;
            bottom: 15px;
            width: 100%;
            display: none;
            justify-content: space-between;
            padding: 0 15px;
            z-index: 500;
        }

        #controls.active {
            display: flex;
        }

        .control-group {
            display: flex;
            gap: 8px;
        }

        .control-btn {
            width: 75px;
            height: 75px;
            background: rgba(139, 0, 0, 0.95);
            border: 3px solid #FFD700;
            border-radius: 10px;
            color: #FFD700;
            font-size: 0.75em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            touch-action: none;
            font-weight: bold;
            box-shadow: 0 4px 0 #3a0000, 0 6px 10px rgba(0,0,0,0.5);
            font-family: 'MedievalSharp', serif;
        }

        .control-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 #3a0000, 0 2px 5px rgba(0,0,0,0.4);
        }

        #hud {
            position: fixed;
            top: 15px;
            width: 100%;
            display: none;
            z-index: 500;
        }

        #hud.active {
            display: block;
        }

        .health-container {
            display: flex;
            justify-content: space-between;
            padding: 0 15px;
            margin-bottom: 10px;
        }

        .health-bar {
            width: 38%;
            height: 35px;
            background: rgba(0, 0, 0, 0.8);
            border: 3px solid #FFD700;
            border-radius: 4px;
            position: relative;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.5);
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(180deg, #DC143C 0%, #8B0000 100%);
            transition: width 0.3s;
            border-radius: 2px;
            box-shadow: inset 0 -2px 5px rgba(0,0,0,0.3);
        }

        .health-text {
            position: absolute;
            width: 100%;
            text-align: center;
            line-height: 35px;
            font-size: 0.85em;
            color: #FFD700;
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
        }

        #levelInfo {
            text-align: center;
            font-size: 1.1em;
            color: #FFD700;
            font-weight: bold;
            text-shadow: 2px 2px 4px #000;
            letter-spacing: 2px;
        }

        .loading {
            text-align: center;
            font-size: 1.5em;
            color: #FFD700;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <!-- Main Menu -->
    <div id="mainMenu" class="screen active">
        <h1 class="title">‚öîÔ∏è KNIGHT'S ASCENT ‚öîÔ∏è</h1>
        <button class="menu-btn" onclick="game.startGame()">‚öî START CAMPAIGN</button>
        <button class="menu-btn" onclick="game.showOptions()">‚öô OPTIONS</button>
        <div class="loading" id="loadingText">Loading assets...</div>
    </div>

    <!-- Options Screen -->
    <div id="optionsScreen" class="screen">
        <h1 class="title">OPTIONS</h1>
        <div class="options-container">
            <div class="option-row">
                <div class="option-label">GORE MODE:</div>
                <div class="option-btns">
                    <button class="option-btn selected" data-opt="gore-on" onclick="game.setGore(true)">ENABLED</button>
                    <button class="option-btn" data-opt="gore-off" onclick="game.setGore(false)">DISABLED</button>
                </div>
            </div>
            <div class="option-row">
                <div class="option-label">DIFFICULTY:</div>
                <div class="option-btns">
                    <button class="option-btn selected" data-opt="diff-normal" onclick="game.setDifficulty(0.8)">NORMAL</button>
                    <button class="option-btn" data-opt="diff-hard" onclick="game.setDifficulty(1.2)">HARD</button>
                    <button class="option-btn" data-opt="diff-brutal" onclick="game.setDifficulty(1.6)">BRUTAL</button>
                </div>
            </div>
        </div>
        <button class="back-btn" onclick="game.showMenu()">‚¨Ö BACK TO MENU</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="hud">
        <div class="health-container">
            <div class="health-bar">
                <div class="health-fill" id="playerHealth" style="width: 100%"></div>
                <div class="health-text">YOU</div>
            </div>
            <div class="health-bar">
                <div class="health-fill" id="enemyHealth" style="width: 100%"></div>
                <div class="health-text">ENEMY</div>
            </div>
        </div>
        <div id="levelInfo">LEVEL 1: FIELD BATTLE</div>
    </div>

    <div id="controls">
        <div class="control-group">
            <div class="control-btn" id="leftBtn">‚Üê<br>LEFT</div>
            <div class="control-btn" id="rightBtn">‚Üí<br>RIGHT</div>
        </div>
        <div class="control-group">
            <div class="control-btn" id="blockBtn">üõ°<br>BLOCK</div>
            <div class="control-btn" id="dodgeBtn">‚Üî<br>DODGE</div>
            <div class="control-btn" id="attackBtn">‚öî<br>ATTACK</div>
        </div>
    </div>

    <script>
        const game = {
            canvas: null,
            ctx: null,
            gore: true,
            difficultyMultiplier: 1,
            currentLevel: 0,
            player: { 
                x: 200, y: 0,
                health: 100, maxHealth: 100,
                isBlocking: false, 
                isAttacking: false, 
                isDodging: false,
                attackFrame: 0,
                animFrame: 0,
                animTimer: 0,
                velX: 0
            },
            enemy: { 
                x: 700, y: 0,
                health: 100, maxHealth: 100,
                isBlocking: false, 
                isAttacking: false,
                attackFrame: 0,
                animFrame: 0,
                animTimer: 0,
                aiTimer: 0,
                aiCooldown: 0
            },
            blood: [],
            gameRunning: false,
            assets: {},
            assetsLoaded: false,
            groundY: 0,

            levels: [
                { 
                    name: 'FIELD BATTLE',
                    bgUrl: 'https://pub-b70cb36a6853407fa468c5d6dec16633.r2.dev/208307/gemini/generate_image/response/a479852528778d342fc3039cfcbfe12f',
                    enemy: 'Peasant Warrior',
                    difficulty: 1
                },
                {
                    name: 'VILLAGE SQUARE',
                    bgUrl: 'https://pub-b70cb36a6853407fa468c5d6dec16633.r2.dev/208307/gemini/generate_image/response/a2662d71b32b1a6ad73d78db07098e8b',
                    enemy: 'Town Guard',
                    difficulty: 1.3
                },
                {
                    name: 'CASTLE COURTYARD',
                    bgUrl: 'https://pub-b70cb36a6853407fa468c5d6dec16633.r2.dev/208307/gemini/generate_image/response/11091d5c1a0be80919b4d87957931056',
                    enemy: 'Royal Knight',
                    difficulty: 1.6
                },
                {
                    name: 'THRONE ROOM',
                    bgUrl: 'https://pub-b70cb36a6853407fa468c5d6dec16633.r2.dev/208307/gemini/generate_image/response/224003a466ee5c1e77e35c25c4618664',
                    enemy: 'THE KING',
                    difficulty: 2
                }
            ],

            init() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.setupControls();
                this.loadAssets();
                this.loadSettings();
            },

            resize() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                this.groundY = this.canvas.height - 120;
                this.player.y = this.groundY - 100;
                this.enemy.y = this.groundY - 100;
            },

            loadAssets() {
                const toLoad = [
                    { key: 'knight', src: 'https://pub-b70cb36a6853407fa468c5d6dec16633.r2.dev/208307/gemini/generate_image/response/1f47fd3d272899cd03691673437e8ded' },
                    { key: 'sword', src: 'https://pub-b70cb36a6853407fa468c5d6dec16633.r2.dev/208307/gemini/generate_image/response/da553ca38cbb42d23c10387c29373ef0' },
                    ...this.levels.map((l, i) => ({ key: `bg${i}`, src: l.bgUrl }))
                ];

                let loaded = 0;
                const total = toLoad.length;

                toLoad.forEach(item => {
                    const img = new Image();
                    img.crossOrigin = "anonymous";
                    img.onload = () => {
                        this.assets[item.key] = img;
                        loaded++;
                        if (loaded === total) {
                            this.assetsLoaded = true;
                            document.getElementById('loadingText').textContent = 'Ready! Start Campaign to begin.';
                        } else {
                            document.getElementById('loadingText').textContent = `Loading... ${loaded}/${total}`;
                        }
                    };
                    img.onerror = () => {
                        loaded++;
                        console.log(`Failed to load: ${item.key}`);
                        if (loaded === total) {
                            this.assetsLoaded = true;
                            document.getElementById('loadingText').textContent = 'Ready! (Some assets failed)';
                        }
                    };
                    img.src = item.src;
                });
            },

            loadSettings() {
                this.gore = localStorage.getItem('gore') !== 'false';
                this.difficultyMultiplier = parseFloat(localStorage.getItem('difficulty')) || 1;
                this.updateOptionButtons();
            },

            showMenu() {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('mainMenu').classList.add('active');
                document.getElementById('hud').classList.remove('active');
                document.getElementById('controls').classList.remove('active');
                this.gameRunning = false;
            },

            showOptions() {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('optionsScreen').classList.add('active');
                this.updateOptionButtons();
            },

            setGore(enabled) {
                this.gore = enabled;
                localStorage.setItem('gore', enabled);
                this.updateOptionButtons();
            },

            setDifficulty(mult) {
                this.difficultyMultiplier = mult;
                localStorage.setItem('difficulty', mult);
                this.updateOptionButtons();
            },

            updateOptionButtons() {
                document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
                document.querySelector(`[data-opt="gore-${this.gore ? 'on' : 'off'}"]`)?.classList.add('selected');
                const diffMap = {0.8: 'normal', 1.2: 'hard', 1.6: 'brutal'};
                document.querySelector(`[data-opt="diff-${diffMap[this.difficultyMultiplier]}"]`)?.classList.add('selected');
            },

            startGame() {
                if (!this.assetsLoaded) {
                    alert('Please wait for assets to load!');
                    return;
                }
                this.currentLevel = 0;
                this.loadLevel(0);
            },

            loadLevel(level) {
                this.currentLevel = level;
                this.player.health = this.player.maxHealth;
                this.enemy.health = this.enemy.maxHealth;
                this.player.x = 200;
                this.enemy.x = this.canvas.width - 250;
                this.player.y = this.groundY - 100;
                this.enemy.y = this.groundY - 100;
                this.blood = [];
                this.enemy.aiTimer = 0;
                this.enemy.aiCooldown = 0;
                this.player.animFrame = 0;
                this.enemy.animFrame = 0;

                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('hud').classList.add('active');
                document.getElementById('controls').classList.add('active');
                document.getElementById('levelInfo').textContent = `LEVEL ${level + 1}: ${this.levels[level].name}`;

                this.gameRunning = true;
                this.gameLoop();
            },

            setupControls() {
                const actions = {
                    'leftBtn': 'left',
                    'rightBtn': 'right',
                    'attackBtn': 'attack',
                    'blockBtn': 'block',
                    'dodgeBtn': 'dodge'
                };

                Object.keys(actions).forEach(btnId => {
                    const btn = document.getElementById(btnId);
                    const action = actions[btnId];

                    ['touchstart', 'mousedown'].forEach(evt => {
                        btn.addEventListener(evt, (e) => {
                            e.preventDefault();
                            this.handleAction(action, true);
                        });
                    });

                    ['touchend', 'mouseup'].forEach(evt => {
                        btn.addEventListener(evt, (e) => {
                            e.preventDefault();
                            this.handleAction(action, false);
                        });
                    });
                });

                window.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowLeft' || e.key === 'a') this.handleAction('left', true);
                    if (e.key === 'ArrowRight' || e.key === 'd') this.handleAction('right', true);
                    if (e.key === ' ' || e.key === 'j') { e.preventDefault(); this.handleAction('attack', true); }
                    if (e.key === 'ArrowDown' || e.key === 's') this.handleAction('block', true);
                    if (e.key === 'ArrowUp' || e.key === 'w') { e.preventDefault(); this.handleAction('dodge', true); }
                });

                window.addEventListener('keyup', (e) => {
                    if (e.key === 'ArrowLeft' || e.key === 'a') this.handleAction('left', false);
                    if (e.key === 'ArrowRight' || e.key === 'd') this.handleAction('right', false);
                    if (e.key === 'ArrowDown' || e.key === 's') this.handleAction('block', false);
                });
            },

            handleAction(action, pressed) {
                if (!this.gameRunning) return;

                switch(action) {
                    case 'left':
                        this.player.velX = pressed ? -4 : 0;
                        break;
                    case 'right':
                        this.player.velX = pressed ? 4 : 0;
                        break;
                    case 'attack':
                        if (pressed && !this.player.isAttacking && !this.player.isDodging) {
                            this.player.isAttacking = true;
                            this.player.attackFrame = 15;
                            setTimeout(() => this.playerAttack(), 200);
                        }
                        break;
                    case 'block':
                        if (!this.player.isAttacking && !this.player.isDodging) {
                            this.player.isBlocking = pressed;
                        }
                        break;
                    case 'dodge':
                        if (pressed && !this.player.isDodging && !this.player.isAttacking) {
                            this.player.isDodging = true;
                            const dir = this.player.x < this.canvas.width / 2 ? 1 : -1;
                            this.player.x += 60 * dir;
                            setTimeout(() => this.player.isDodging = false, 300);
                        }
                        break;
                }
            },

            playerAttack() {
                const dist = Math.abs(this.player.x - this.enemy.x);
                if (dist < 120 && !this.enemy.isBlocking) {
                    this.enemy.health -= 15;
                    this.addBlood(this.enemy.x, this.enemy.y + 40);
                    this.updateHealthBars();
                }
            },

            enemyAI() {
                if (!this.gameRunning || this.enemy.aiCooldown > 0) {
                    this.enemy.aiCooldown--;
                    return;
                }

                this.enemy.aiTimer++;
                if (this.enemy.aiTimer < 40) return;
                this.enemy.aiTimer = 0;

                const dist = Math.abs(this.player.x - this.enemy.x);
                const levelDiff = this.levels[this.currentLevel].difficulty * this.difficultyMultiplier;

                if (dist > 130) {
                    this.enemy.x -= 3;
                } else {
                    const rand = Math.random();
                    if (rand < 0.3 * levelDiff && !this.enemy.isAttacking) {
                        this.enemy.isAttacking = true;
                        this.enemy.attackFrame = 15;
                        this.enemy.aiCooldown = 40;
                        setTimeout(() => {
                            const d = Math.abs(this.player.x - this.enemy.x);
                            if (d < 120 && !this.player.isBlocking && !this.player.isDodging) {
                                this.player.health -= 12 * levelDiff;
                                this.addBlood(this.player.x, this.player.y + 40);
                                this.updateHealthBars();
                            }
                            this.enemy.isAttacking = false;
                        }, 300);
                    } else if (rand < 0.5 * levelDiff) {
                        this.enemy.isBlocking = true;
                        this.enemy.aiCooldown = 50;
                        setTimeout(() => {
                            this.enemy.isBlocking = false;
                        }, 700);
                    }
                }
            },

            addBlood(x, y) {
                if (!this.gore) return;
                for (let i = 0; i < 10; i++) {
                    this.blood.push({
                        x, y,
                        vx: (Math.random() - 0.5) * 8,
                        vy: -Math.random() * 6 - 2,
                        life: 100,
                        size: Math.random() * 5 + 2
                    });
                }
            },

            updateHealthBars() {
                const pp = Math.max(0, this.player.health / this.player.maxHealth * 100);
                const ep = Math.max(0, this.enemy.health / this.enemy.maxHealth * 100);
                document.getElementById('playerHealth').style.width = pp + '%';
                document.getElementById('enemyHealth').style.width = ep + '%';

                if (this.player.health <= 0) this.gameOver(false);
                else if (this.enemy.health <= 0) this.levelComplete();
            },

            gameOver(won) {
                this.gameRunning = false;
                setTimeout(() => {
                    if (won) {
                        alert('‚öîÔ∏è VICTORY! You have defeated all enemies and claimed the throne!');
                    } else {
                        alert('üíÄ DEFEAT! You have fallen in battle. Train harder, warrior!');
                    }
                    this.showMenu();
                }, 700);
            },

            levelComplete() {
                this.gameRunning = false;
                setTimeout(() => {
                    if (this.currentLevel < this.levels.length - 1) {
                        alert(`‚úÖ Level ${this.currentLevel + 1} Complete!\n\nPrepare for the next battle: ${this.levels[this.currentLevel + 1].name}`);
                        this.loadLevel(this.currentLevel + 1);
                    } else {
                        this.gameOver(true);
                    }
                }, 700);
            },

            drawSprite(img, sx, sy, sw, sh, dx, dy, dw, dh, flipX = false) {
                if (!img) return;
                this.ctx.save();
                if (flipX) {
                    this.ctx.translate(dx + dw, dy);
                    this.ctx.scale(-1, 1);
                    this.ctx.drawImage(img, sx, sy, sw, sh, 0, 0, dw, dh);
                } else {
                    this.ctx.drawImage(img, sx, sy, sw, sh, dx, dy, dw, dh);
                }
                this.ctx.restore();
            },

            gameLoop() {
                if (!this.gameRunning) return;

                const ctx = this.ctx;

                // Clear
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // Background
                const bgKey = `bg${this.currentLevel}`;
                if (this.assets[bgKey]) {
                    ctx.drawImage(this.assets[bgKey], 0, 0, this.canvas.width, this.canvas.height);
                } else {
                    // Fallback gradient
                    const grad = ctx.createLinearGradient(0, 0, 0, this.canvas.height);
                    grad.addColorStop(0, '#4a6fa5');
                    grad.addColorStop(0.7, '#2a5f2a');
                    grad.addColorStop(1, '#1a4a1a');
                    ctx.fillStyle = grad;
                    ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                }

                // Ground
                ctx.fillStyle = 'rgba(40, 60, 40, 0.5)';
                ctx.fillRect(0, this.groundY, this.canvas.width, this.canvas.height - this.groundY);

                // Blood particles
                this.blood = this.blood.filter(drop => {
                    drop.x += drop.vx;
                    drop.y += drop.vy;
                    drop.vy += 0.5;
                    drop.life--;

                    if (drop.y >= this.groundY) {
                        drop.y = this.groundY;
                        drop.vy = 0;
                        drop.vx *= 0.7;
                    }

                    if (drop.life > 0) {
                        ctx.fillStyle = `rgba(139, 0, 0, ${drop.life / 100})`;
                        ctx.beginPath();
                        ctx.arc(drop.x, drop.y, drop.size, 0, Math.PI * 2);
                        ctx.fill();
                        return true;
                    }
                    return false;
                });

                // Update player position
                if (!this.player.isAttacking) {
                    this.player.x += this.player.velX;
                    this.player.x = Math.max(80, Math.min(this.canvas.width / 2 - 50, this.player.x));
                }

                // Draw shadows
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.ellipse(this.player.x + 30, this.groundY + 10, 30, 8, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.ellipse(this.enemy.x + 30, this.groundY + 10, 30, 8, 0, 0, Math.PI * 2);
                ctx.fill();

                // Draw knights (simplified but better than before)
                this.drawKnight(this.player.x, this.player.y, false, this.player);
                this.drawKnight(this.enemy.x, this.enemy.y, true, this.enemy);

                // Update animations
                if (this.player.attackFrame > 0) {
                    this.player.attackFrame--;
                    if (this.player.attackFrame === 0) this.player.isAttacking = false;
                }
                if (this.enemy.attackFrame > 0) {
                    this.enemy.attackFrame--;
                }

                // AI
                this.enemyAI();

                requestAnimationFrame(() => this.gameLoop());
            },

            drawKnight(x, y, isEnemy, entity) {
                const ctx = this.ctx;
                const size = 80;

                // Draw knight sprite if available, otherwise fallback to better shapes
                if (this.assets.knight) {
                    // Use actual sprite (simplified for now - would need proper frame extraction)
                    this.drawSprite(this.assets.knight, 0, 0, 100, 100, x, y, size, size, isEnemy);
                } else {
                    // Improved fallback rendering
                    const color = isEnemy ? '#8B0000' : '#c0c0c0';

                    // Legs
                    ctx.fillStyle = color;
                    ctx.fillRect(x + 20, y + 50, 12, 35);
                    ctx.fillRect(x + 38, y + 50, 12, 35);

                    // Body
                    ctx.fillStyle = color;
                    ctx.fillRect(x + 15, y + 25, 40, 30);

                    // Cape
                    ctx.fillStyle = isEnemy ? '#3a0000' : '#DC143C';
                    if (isEnemy) {
                        ctx.fillRect(x + 10, y + 28, 10, 25);
                    } else {
                        ctx.fillRect(x + 50, y + 28, 10, 25);
                    }

                    // Arms
                    if (entity.isBlocking) {
                        ctx.fillRect(x + 8, y + 28, 10, 22);
                        ctx.fillRect(x + 52, y + 28, 10, 22);
                    } else if (entity.isAttacking && entity.attackFrame > 5) {
                        const ext = isEnemy ? -18 : 18;
                        ctx.fillRect(x + 35 + ext, y + 25, 10, 25);
                    } else {
                        ctx.fillRect(x + 8, y + 30, 10, 22);
                        ctx.fillRect(x + 52, y + 30, 10, 22);
                    }

                    // Helmet
                    ctx.fillStyle = '#888';
                    ctx.fillRect(x + 18, y + 8, 34, 18);
                    ctx.fillStyle = '#333';
                    ctx.fillRect(x + 22, y + 14, 26, 4);

                    // Cross on chest (if player)
                    if (!isEnemy) {
                        ctx.fillStyle = '#DC143C';
                        ctx.fillRect(x + 32, y + 32, 6, 12);
                        ctx.fillRect(x + 28, y + 36, 14, 4);
                    }

                    // Sword
                    this.drawSword(x, y, isEnemy, entity);
                }
            },

            drawSword(x, y, isEnemy, entity) {
                const ctx = this.ctx;
                const swordLen = 50;
                const dir = isEnemy ? -1 : 1;

                ctx.fillStyle = '#c0c0c0';

                if (entity.isAttacking && entity.attackFrame > 5) {
                    // Attacking pose - sword extended
                    const angle = (entity.attackFrame / 15) * -60;
                    ctx.save();
                    ctx.translate(x + 40 + (dir * 20), y + 30);
                    ctx.rotate((angle * dir) * Math.PI / 180);
                    ctx.fillRect(0, 0, 6, swordLen);
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(-2, swordLen, 10, 10);
                    ctx.restore();
                } else {
                    // Rest position
                    ctx.fillRect(x + 45 + (dir * 15), y + 30, 6, swordLen);
                    ctx.fillStyle = '#8B4513';
                    ctx.fillRect(x + 42 + (dir * 15), y + 30 + swordLen, 12, 10);
                }
            }
        };

        window.addEventListener('load', () => {
            game.init();
        });
    </script>
</body>
</html>